graph TB

    %% ===== User / UI Layer =====
    USER["ðŸ‘¤ User in Browser"]

    subgraph UI["Next.js / Web UI (Visualization)"]
        MAP["Map View<br/>camera markers<br/>green/yellow/red"]
        TL["Timeline Panel<br/>keyframes + clips"]
        KP["Keyframe Gallery<br/>lazy-load thumbnails"]
        CH["Charts<br/>vehicle & pedestrian counts"]
        VID["HTML5 Video Player<br/>MP4 with baked boxes<br/>captions optional"]
        ACC["Accessibility<br/>keyboard nav + captions"]
    end

    %% ===== API Layer =====
    subgraph API["FastAPI"]
        MAP_EP["GET /api/map/cameras<br/>live status"]
        TL_EP["GET /api/timeline/:camera_id<br/>keyframe timeline"]
        CLIP_EP["GET /api/stream/:clip_id<br/>signed S3 URL"]
        THUMB_EP["GET /api/thumbnails/:frame_id<br/>signed URL"]
        CH_EP["GET /api/charts/:camera_id<br/>counts"]
    end

    %% ===== Data / Media =====
    subgraph DATA["Data Sources"]
        RDS["PostgreSQL RDS<br/>camera status, metadata"]
        S3KF["S3 keyframes/<br/>thumbnails (lazy)"]
        S3CLIP["S3 clips/<br/>MP4 with boxes"]
    end

    %% ===== Flows =====
    USER --> MAP
    USER --> ACC

    %% map needs camera status
    MAP --> MAP_EP
    MAP_EP --> RDS

    %% marker click â†’ load timeline
    MAP -->|"select camera"| TL
    TL --> TL_EP
    TL_EP --> RDS
    TL_EP --> S3KF

    %% keyframes (lazy thumbnails)
    KP --> THUMB_EP
    THUMB_EP --> S3KF

    %% charts
    TL --> CH
    CH --> CH_EP
    CH_EP --> RDS

    %% video playback
    TL -->|"select clip"| VID
    VID --> CLIP_EP
    CLIP_EP --> S3CLIP

    %% ===== Styling =====
    style UI fill:#e6f7ff,stroke:#339,stroke-width:1px
    style API fill:#f0f5ff,stroke:#335,stroke-width:1px
    style DATA fill:#fff9e6,stroke:#d9a520,stroke-width:1px
    style RDS fill:#cce5ff,stroke:#335
    style S3KF fill:#e6ffe6,stroke:#333
    style S3CLIP fill:#e6f3ff,stroke:#333
    style JSONIDX fill:#fff4cc
    style MV fill:#d6e4ff
