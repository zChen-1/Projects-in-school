graph TB

    subgraph Clients["Clients"]
        VIEWER["ðŸ‘¤ Viewer"]
        RESEARCHER["ðŸ‘¤ Researcher"]
    end

    subgraph API["FastAPI Search Layer"]
        AUTH["JWT Auth<br/>HS256<br/>roles: viewer, researcher"]

        LIST_CAMS["GET /api/cameras<br/>list cameras + status"]
        KEYFRAMES["GET /api/keyframes<br/>camera_id + time_range<br/>ret: JSON + signed URLs"]
        STATS["GET /api/statistics<br/>ret: aggregated counts"]
        BUSIEST["GET /api/statistics/busiest<br/>ret: mat. view"]
        CLIPS["GET /api/clips<br/>ret: JSON + signed S3 URLs"]
        EXPORT_REQ["POST /api/export<br/>async export<br/>(researcher)"]
        EXPORT_STATUS["GET /api/export/:job_id"]
    end

    subgraph DB["PostgreSQL RDS"]
        TABLES["camera, frames, events<br/>idx: camera_id, timestamp"]
        JSONIDX["JSONB idx on class_counts<br/>for fast object queries"]
        MV["Materialized View<br/>busiest windows per day"]
    end

    subgraph Storage["S3 Media"]
        S3KF["keyframes/"]
        S3CLIPS["clips/"]
    end

    subgraph Jobs["Async Export System"]
        JOBQ["Export Job Queue"]
        JOBPKG["Package + stage result"]
    end

    %% ===== Flows =====
    VIEWER --> AUTH
    RESEARCHER --> AUTH

    AUTH --> LIST_CAMS
    AUTH --> KEYFRAMES
    AUTH --> STATS
    AUTH --> BUSIEST
    AUTH --> CLIPS
    AUTH --> EXPORT_REQ
    AUTH --> EXPORT_STATUS

    LIST_CAMS --> TABLES
    KEYFRAMES --> TABLES
    KEYFRAMES --> JSONIDX
    STATS --> TABLES
    BUSIEST --> MV
    CLIPS --> TABLES

    KEYFRAMES --> S3KF
    CLIPS --> S3CLIPS

    EXPORT_REQ --> JOBQ
    JOBQ --> JOBPKG
    JOBPKG --> S3CLIPS
    JOBPKG --> S3KF
    JOBPKG --> TABLES
    JOBPKG --> EXPORT_STATUS

    style API fill:#e6f7ff,stroke:#339,stroke-width:1px
    style DB fill:#edf0ff,stroke:#335,stroke-width:1px
    style Storage fill:#f9ffff,stroke:#339,stroke-width:1px
    style Jobs fill:#fff9e6,stroke:#d9a520,stroke-width:1px
    style VIEWER fill:#ffe1e1
    style RESEARCHER fill:#ffe1e1
    style S3KF fill:#e6ffe6
    style S3CLIPS fill:#e6f3ff
    style JSONIDX fill:#fff4cc
    style MV fill:#d6e4ff
